<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ã¨ã‚‚ã ã¡ãƒ­ãƒœ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:root {
  --peach:#FFD4B3; --orange:#FF9470; --dark-orange:#E8896A;
  --bg:#FFF8F2; --white:#fff; --gray:#999; --text:#444;
  --blue:#64B5F6; --green:#66BB6A;
}
body {
  background:var(--bg);
  font-family:'Nunito','Hiragino Maru Gothic ProN','Yu Gothic',sans-serif;
  position:fixed; inset:0; overflow:hidden;
}

/* â”€â”€ BACKGROUND BLOBS â”€â”€ */
.blobs { position:fixed; inset:0; pointer-events:none; z-index:0; }
.blob { position:absolute; border-radius:50%; filter:blur(70px); opacity:.28; }
.b1 { width:420px;height:420px;background:#FFD6A5;top:-120px;left:-120px; }
.b2 { width:380px;height:380px;background:#C8FAC0;bottom:-100px;right:-100px; }
.b3 { width:320px;height:320px;background:#BDE0FE;top:50%;left:50%;transform:translate(-50%,-50%); }

/* â”€â”€ SCREENS â”€â”€ */
.screen {
  position:absolute; inset:0;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:24px; opacity:0; pointer-events:none; transition:opacity .3s; z-index:1;
}
.screen.active { opacity:1; pointer-events:all; }

/* â”€â”€ SETUP â”€â”€ */
#screen-setup { gap:0; }
.setup-card {
  background:var(--white); border-radius:28px; padding:32px 28px;
  width:100%; max-width:420px;
  box-shadow:0 12px 40px rgba(0,0,0,.08);
}
.setup-card h2 { font-size:21px; color:var(--dark-orange); font-weight:900; margin-bottom:6px; }
.setup-card .sub { font-size:13px; color:var(--gray); margin-bottom:22px; line-height:1.6; }
.fg { margin-bottom:14px; }
.fg label { display:block; font-size:13px; font-weight:700; color:var(--text); margin-bottom:5px; }
.fg input, .fg textarea {
  width:100%; padding:11px 15px; border:2px solid #eee; border-radius:12px;
  font-size:14px; font-family:inherit; outline:none; transition:border-color .2s;
  background:var(--white);
}
.fg input:focus, .fg textarea:focus { border-color:var(--orange); }
.fg textarea { resize:none; height:78px; }
.btn-p {
  width:100%; padding:15px; background:linear-gradient(135deg,#FF9470,#FFB84D);
  color:var(--white); border:none; border-radius:16px;
  font-size:16px; font-weight:900; cursor:pointer; font-family:inherit;
  box-shadow:0 6px 20px rgba(255,148,112,.4); transition:transform .15s;
}
.btn-p:active { transform:scale(.97); }
.btn-s {
  padding:11px 22px; background:var(--white); color:var(--text);
  border:2px solid #eee; border-radius:12px; font-size:14px; font-weight:700;
  cursor:pointer; font-family:inherit;
}

/* â”€â”€ NAMING OVERLAY â”€â”€ */
#overlay-naming {
  display:none; position:fixed; inset:0; z-index:30;
  background:rgba(255,248,242,.96); backdrop-filter:blur(4px);
  flex-direction:column; align-items:center; justify-content:center; gap:20px; padding:24px;
}
#overlay-naming.active { display:flex; }
.naming-title { font-size:23px; font-weight:900; color:var(--dark-orange); text-align:center; line-height:1.5; }
#naming-input {
  font-size:32px; font-weight:900; text-align:center; border:none;
  border-bottom:4px solid var(--orange); background:transparent; outline:none;
  width:220px; color:var(--text); font-family:inherit; padding:8px 4px;
}

/* â”€â”€ MAIN SCREEN â”€â”€ */
#screen-main { gap:0; }
.top-bar { position:absolute; top:20px; right:20px; }
.parent-btn {
  background:var(--white); border:none; border-radius:999px;
  padding:10px 18px; font-size:13px; color:var(--gray); font-weight:700;
  cursor:pointer; font-family:inherit;
  box-shadow:0 3px 12px rgba(0,0,0,.08);
}

.character-area {
  display:flex; flex-direction:column; align-items:center;
  gap:14px; flex:1; justify-content:center;
}

.bubble {
  background:var(--white); border-radius:22px; padding:14px 22px;
  font-size:17px; color:#555; font-weight:700;
  box-shadow:0 8px 28px rgba(0,0,0,.07);
  max-width:290px; text-align:center; line-height:1.6;
  position:relative; min-height:56px;
  display:flex; align-items:center; justify-content:center;
  transition:opacity .25s;
}
.bubble::after {
  content:''; position:absolute; bottom:-12px; left:50%; transform:translateX(-50%);
  border:8px solid transparent; border-top-color:var(--white); border-bottom:none;
}

/* CHARACTER */
.char-wrap {
  animation:float 3.6s ease-in-out infinite;
  cursor:pointer;
  filter:drop-shadow(0 22px 32px rgba(255,160,100,.22));
  transition:filter .3s;
  -webkit-user-select:none; user-select:none;
}
.char-wrap.listening {
  filter:drop-shadow(0 0 32px rgba(100,181,246,.7));
  animation:float-glow 1.6s ease-in-out infinite;
}
.char-wrap.talking {
  filter:drop-shadow(0 0 32px rgba(102,187,106,.65));
  animation:float-talk .5s ease-in-out infinite;
}
.char-wrap.thinking {
  animation:float-think 1s ease-in-out infinite;
}
@keyframes float { 0%,100%{transform:translateY(0)rotate(-1deg)} 50%{transform:translateY(-16px)rotate(1deg)} }
@keyframes float-glow { 0%,100%{transform:translateY(0)scale(1)} 50%{transform:translateY(-8px)scale(1.03)} }
@keyframes float-talk { 0%,100%{transform:translateY(-4px)} 50%{transform:translateY(4px)} }
@keyframes float-think { 0%,100%{transform:translateY(0)rotate(-2deg)} 50%{transform:translateY(-6px)rotate(2deg)} }

/* Eye blink */
.eld { transform-origin:78px 110px; animation:blink 4.2s ease-in-out infinite; }
.erd { transform-origin:122px 110px; animation:blink 4.2s ease-in-out infinite .06s; }
@keyframes blink { 0%,88%,100%{transform:scaleY(1)} 93%{transform:scaleY(.05)} }
/* Antennae */
.al { transform-origin:72px 55px; animation:wig 2.8s ease-in-out infinite; }
.ar { transform-origin:128px 55px; animation:wig 2.8s ease-in-out infinite .35s; }
@keyframes wig { 0%,100%{transform:rotate(-6deg)} 50%{transform:rotate(6deg)} }
/* Mouth talking */
.char-wrap.talking .mouth { animation:talk .28s ease-in-out infinite alternate; transform-origin:100px 150px; }
@keyframes talk { from{transform:scaleY(1)} to{transform:scaleY(1.6) translateY(2px)} }

.char-name {
  font-size:20px; color:var(--dark-orange); font-weight:900; letter-spacing:.06em;
  background:var(--white); padding:8px 28px; border-radius:999px;
  box-shadow:0 4px 16px rgba(244,132,95,.18);
}
.tap-hint { font-size:13px; color:#ccc; font-weight:700; letter-spacing:.04em; }

/* Status bar */
.status-bar {
  position:absolute; bottom:36px; left:50%; transform:translateX(-50%);
  display:flex; align-items:center; gap:8px;
}
.sdot { width:10px;height:10px;border-radius:50%;background:#ddd;transition:background .3s; }
.sdot.listening { background:var(--blue); animation:pulse 1s infinite; }
.sdot.talking { background:var(--green); animation:pulse 1s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
.stxt { font-size:13px; color:var(--gray); font-weight:700; }

/* â”€â”€ PARENT LOGIN â”€â”€ */
#screen-parent-login { gap:10px; }
.lock-ico { font-size:52px; }
.phead { font-size:18px; font-weight:900; color:var(--dark-orange); }
.psub { font-size:13px; color:var(--gray); }
.pin-row { display:flex; gap:14px; margin:12px 0 4px; }
.pin-dot { width:18px;height:18px;border-radius:50%;border:2.5px solid var(--orange);transition:background .15s; }
.pin-dot.on { background:var(--orange); }
.pin-err { font-size:13px; color:#ff6b6b; font-weight:700; height:18px; }
.numpad { display:grid; grid-template-columns:repeat(3,72px); gap:12px; margin-top:10px; }
.nbtn {
  width:72px;height:72px;border-radius:50%;border:none;
  background:var(--white); font-size:24px; font-weight:700; color:var(--text);
  cursor:pointer; font-family:inherit;
  box-shadow:0 3px 10px rgba(0,0,0,.07); transition:transform .1s;
}
.nbtn:active { transform:scale(.9); background:var(--peach); }
.nbtn.ok { background:#FFE8D6; font-size:20px; }

/* â”€â”€ PARENT SETTINGS â”€â”€ */
#screen-parent-settings { justify-content:flex-start; padding:0; }
.ps-header {
  width:100%; background:var(--white); padding:20px 20px 0;
  box-shadow:0 2px 10px rgba(0,0,0,.06); position:sticky; top:0; z-index:2;
}
.ps-header-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
.ps-header h2 { font-size:20px; font-weight:900; color:var(--dark-orange); }
.tabs { display:flex; gap:0; }
.tbtn {
  padding:10px 14px; background:none; border:none; border-bottom:3px solid transparent;
  font-size:14px; font-weight:700; color:var(--gray); cursor:pointer; font-family:inherit;
  transition:color .2s,border-color .2s;
}
.tbtn.active { color:var(--dark-orange); border-bottom-color:var(--orange); }

.ps-body { flex:1; overflow-y:auto; width:100%; padding:20px; max-width:480px; margin:0 auto; }
.tpanel { display:none; }
.tpanel.active { display:block; }

.sec { margin-bottom:24px; }
.sec h3 { font-size:15px; font-weight:900; color:var(--text); margin-bottom:12px; }

.rem-list { display:flex; flex-direction:column; gap:10px; margin-bottom:12px; }
.rem-item {
  background:var(--white); border-radius:14px; padding:14px 16px;
  display:flex; align-items:center; justify-content:space-between;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
}
.rem-lbl { font-size:15px; font-weight:700; color:var(--text); }
.rem-time { font-size:13px; color:var(--gray); margin-top:2px; }
.rem-del { background:none; border:none; font-size:20px; cursor:pointer; padding:4px; color:#ffaaaa; }
.add-rem-form {
  background:var(--white); border-radius:14px; padding:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
  display:flex; flex-direction:column; gap:10px;
}
.log-item {
  background:var(--white); border-radius:14px; padding:14px 16px;
  margin-bottom:10px; box-shadow:0 2px 8px rgba(0,0,0,.05);
}
.log-date { font-size:12px; color:var(--gray); margin-bottom:8px; font-weight:700; }
.log-badge {
  display:inline-block; background:#FFF3CD; color:#E65100;
  border-radius:6px; padding:2px 8px; font-size:11px; font-weight:700; margin-bottom:8px;
}
.lmsg { margin-bottom:5px; font-size:14px; line-height:1.55; }
.lmsg .role { font-weight:700; font-size:12px; margin-right:4px; }
.lmsg.user { color:var(--dark-orange); }
.lmsg.assistant { color:var(--text); }
.no-log { text-align:center; color:var(--gray); font-size:14px; padding:36px 16px; font-weight:700; line-height:1.8; }

/* â”€â”€ SPARKLES â”€â”€ */
.sparkle {
  position:fixed; pointer-events:none; font-size:20px; z-index:999;
  animation:sfly .8s ease-out forwards;
}
@keyframes sfly { from{opacity:1;transform:translateY(0)scale(1)} to{opacity:0;transform:translateY(-75px)scale(.3)} }

/* â”€â”€ REMINDER ALERT â”€â”€ */
.rem-alert {
  position:fixed; bottom:80px; left:50%; transform:translateX(-50%);
  background:var(--orange); color:var(--white);
  padding:12px 26px; border-radius:999px; font-size:15px; font-weight:700;
  z-index:50; box-shadow:0 6px 24px rgba(255,148,112,.45);
  animation:slideUp .4s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap; max-width:90vw;
}
@keyframes slideUp { from{transform:translateX(-50%) translateY(20px);opacity:0} to{transform:translateX(-50%) translateY(0);opacity:1} }

/* back btn */
.back-btn {
  background:var(--white); border:none; border-radius:999px;
  padding:10px 18px; font-size:13px; font-weight:700; color:var(--gray);
  cursor:pointer; font-family:inherit; box-shadow:0 2px 8px rgba(0,0,0,.07);
}
</style>
<style id="print-style">
@media print {
  body > *:not(#print-area) { display:none !important; }
  #print-area {
    display:block !important;
    position:fixed; inset:0;
    background:white;
    padding:48px;
    font-family:'Nunito','Hiragino Maru Gothic ProN',sans-serif;
    text-align:center;
  }
}
#print-area { display:none; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

<!-- BG -->
<div class="blobs"><div class="blob b1"></div><div class="blob b2"></div><div class="blob b3"></div></div>

<!-- ===== SETUP ===== -->
<div class="screen active" id="screen-setup">
  <div class="setup-card">
    <h2>ğŸ”§ ã¯ã˜ã‚ã¦ã®è¨­å®š</h2>
    <p class="sub">ä¿è­·è€…ã®æ–¹ãŒè¨­å®šã—ã¦ãã ã•ã„ã€‚<br>å…¥åŠ›ã—ãŸæƒ…å ±ã¯ã“ã®ãƒ‡ãƒã‚¤ã‚¹å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
    <div class="fg">
      <label>Anthropic APIã‚­ãƒ¼</label>
      <div style="position:relative;">
        <input type="password" id="s-ant" placeholder="sk-ant-..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" style="padding-right:48px;">
        <button type="button" onclick="toggleVis('s-ant',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:#aaa;">ğŸ‘</button>
      </div>
    </div>
    <div class="fg">
      <label>OpenAI APIã‚­ãƒ¼</label>
      <div style="position:relative;">
        <input type="password" id="s-oai" placeholder="sk-..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" style="padding-right:48px;">
        <button type="button" onclick="toggleVis('s-oai',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:#aaa;">ğŸ‘</button>
      </div>
    </div>
    <div class="fg">
      <label>ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ•°å­—4æ¡ï¼‰â€»APIã‚­ãƒ¼å¤‰æ›´ã«ä½¿ç”¨</label>
      <input type="password" id="s-apw" placeholder="ä¾‹ï¼š9999" maxlength="4" inputmode="numeric">
    </div>
    <div class="fg">
      <label>ä¿è­·è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ•°å­—4æ¡ï¼‰â€»ã‚­ãƒ£ãƒ©è¨­å®šãƒ»ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã«ä½¿ç”¨</label>
      <input type="password" id="s-pw" placeholder="ä¾‹ï¼š1234" maxlength="4" inputmode="numeric">
    </div>
    <div class="fg">
      <label>ãƒ­ãƒœãƒƒãƒˆã®æ€§æ ¼ãƒ»è¿½åŠ è¨­å®šï¼ˆä»»æ„ï¼‰</label>
      <textarea id="s-per" placeholder="ä¾‹ï¼šå°‘ã—ãŠã£ã¡ã‚‡ã“ã¡ã‚‡ã„ã§ã€ãŠã‚„ã˜ã‚®ãƒ£ã‚°ãŒå¥½ãã€‚è™«ãŒå¤§å¥½ãã€‚"></textarea>
    </div>
    <button class="btn-p" onclick="completeSetup()">ã¯ã˜ã‚ã‚‹ï¼</button>
  </div>
</div>

<!-- ===== QR SETUP ===== -->
<div class="screen" id="screen-qr-setup">
  <div class="setup-card">
    <div style="display:inline-block;background:#FFF3CD;color:#E65100;border-radius:8px;padding:4px 12px;font-size:12px;font-weight:700;margin-bottom:16px;">ğŸ“± QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰è¨­å®šä¸­</div>
    <h2>ğŸ”§ ã¯ã˜ã‚ã¦ã®è¨­å®š</h2>
    <p class="sub">ä¿è­·è€…ç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨<br>ãƒ­ãƒœãƒƒãƒˆã®æ€§æ ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
    <div style="background:#f9f9f9;border-radius:12px;padding:14px 16px;font-size:12px;color:#bbb;font-weight:700;line-height:1.8;margin-bottom:16px;">
      ğŸ”‘ APIã‚­ãƒ¼ã¨ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯<br>
      <span style="color:#ffb347;">ç®¡ç†è€…ã«ã‚ˆã£ã¦è¨­å®šæ¸ˆã¿ã§ã™ã€‚</span><br>
      å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
    </div>
    <div class="fg">
      <label>ä¿è­·è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ•°å­—4æ¡ï¼‰</label>
      <input type="password" id="q-pw" placeholder="ä¾‹ï¼š1234" maxlength="4" inputmode="numeric">
    </div>
    <hr style="border:none;border-top:2px dashed #f0e8e0;margin:20px 0;">
    <div class="fg">
      <label>ãƒ­ãƒœãƒƒãƒˆã®æ€§æ ¼ãƒ»è¿½åŠ è¨­å®šï¼ˆä»»æ„ï¼‰</label>
      <textarea id="q-per" placeholder="ä¾‹ï¼šå°‘ã—ãŠã£ã¡ã‚‡ã“ã¡ã‚‡ã„ã§ã€ãŠã‚„ã˜ã‚®ãƒ£ã‚°ãŒå¥½ãã€‚è™«ãŒå¤§å¥½ãã€‚"></textarea>
    </div>
    <button class="btn-p" onclick="completeQrSetup()">ã¯ã˜ã‚ã‚‹ï¼</button>
  </div>
</div>

<!-- ===== NAMING OVERLAY ===== -->
<div id="overlay-naming">
  <div style="font-size:80px">ğŸŒŸ</div>
  <div class="naming-title">ã¼ãã®ãªã¾ãˆã‚’<br>ã¤ã‘ã¦ã­ï¼</div>
  <input id="naming-input" type="text" placeholder="ãªã¾ãˆâ€¦" maxlength="10" autocomplete="off"
    onkeydown="if(event.key==='Enter')setCharName()">
  <button class="btn-p" style="max-width:200px" onclick="setCharName()">ã‘ã£ã¦ã„ï¼</button>
</div>

<!-- ===== MAIN (CHILD) ===== -->
<div class="screen" id="screen-main">
  <div class="top-bar" style="display:flex;gap:10px;">
    <button class="parent-btn" onclick="showMemoOverlay()">ğŸ“ ãƒ¡ãƒ¢</button>
    <button class="parent-btn" onclick="goParent('parent')">ğŸ”’ ã»ã”ã—ã‚ƒ</button>
    <button class="parent-btn" onclick="goParent('admin')" style="background:#fff0f0;color:#ffaaaa;">ğŸ”‘</button>
  </div>

  <div class="character-area">
    <div class="bubble" id="bubble">ã‚„ã‚ï¼ã‚¿ãƒƒãƒ—ã—ã¦è©±ã—ã‹ã‘ã¦ã­ï¼</div>

    <div class="char-wrap" id="char" onclick="onTap(event)">
      <svg width="200" height="220" viewBox="0 0 200 220" overflow="visible">
        <!-- Antennae -->
        <g class="al"><line x1="72" y1="55" x2="68" y2="22" stroke="#FFB085" stroke-width="4" stroke-linecap="round"/><circle cx="67" cy="18" r="8" fill="#FF9470"/><circle cx="67" cy="18" r="4" fill="#FFD6C4"/></g>
        <g class="ar"><line x1="128" y1="55" x2="132" y2="22" stroke="#FFB085" stroke-width="4" stroke-linecap="round"/><circle cx="133" cy="18" r="8" fill="#FF9470"/><circle cx="133" cy="18" r="4" fill="#FFD6C4"/></g>
        <!-- Body -->
        <ellipse cx="100" cy="125" rx="70" ry="75" fill="#FFD4B3"/>
        <ellipse cx="82" cy="88" rx="22" ry="16" fill="white" opacity=".35"/>
        <!-- Cheeks -->
        <circle cx="50" cy="130" r="18" fill="#FFB3A0" opacity=".55"/>
        <circle cx="150" cy="130" r="18" fill="#FFB3A0" opacity=".55"/>
        <!-- Left eye -->
        <circle cx="78" cy="110" r="16" fill="white"/>
        <circle cx="80" cy="112" r="9" fill="#3D2B1F"/>
        <circle cx="84" cy="108" r="4" fill="white"/>
        <ellipse class="eld" cx="78" cy="97" rx="16" ry="13" fill="#FFD4B3"/>
        <!-- Right eye -->
        <circle cx="122" cy="110" r="16" fill="white"/>
        <circle cx="124" cy="112" r="9" fill="#3D2B1F"/>
        <circle cx="128" cy="108" r="4" fill="white"/>
        <ellipse class="erd" cx="122" cy="97" rx="16" ry="13" fill="#FFD4B3"/>
        <!-- Nose -->
        <ellipse cx="100" cy="128" rx="5" ry="3.5" fill="#E8896A"/>
        <!-- Mouth -->
        <path class="mouth" id="mouth" d="M84 142 Q100 158 116 142" fill="none" stroke="#E8896A" stroke-width="4" stroke-linecap="round"/>
        <!-- Arms -->
        <ellipse cx="32" cy="148" rx="18" ry="13" fill="#FFD4B3" transform="rotate(-20 32 148)"/>
        <ellipse cx="168" cy="148" rx="18" ry="13" fill="#FFD4B3" transform="rotate(20 168 148)"/>
        <!-- Feet -->
        <ellipse cx="76" cy="194" rx="20" ry="12" fill="#FFB085"/>
        <ellipse cx="124" cy="194" rx="20" ry="12" fill="#FFB085"/>
      </svg>
    </div>

    <div class="char-name" id="char-name-label">â€¦</div>
    <div class="tap-hint">ã‚¿ãƒƒãƒ—ã—ã¦è©±ã—ã‹ã‘ã¦ã­</div>
  </div>

  <div class="status-bar">
    <div class="sdot" id="sdot"></div>
    <div class="stxt" id="stxt"></div>
  </div>
</div>

<!-- ===== PARENT LOGIN ===== -->
<div class="screen" id="screen-parent-login">
  <button class="back-btn" onclick="showScreen('main')" style="position:absolute;top:20px;left:20px;">â† ã‚‚ã©ã‚‹</button>
  <div class="lock-ico">ğŸ”’</div>
  <div class="phead" id="pin-title">ã»ã”ã—ã‚ƒãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <div class="psub">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
  <div class="pin-row" id="pin-row">
    <div class="pin-dot" id="p0"></div><div class="pin-dot" id="p1"></div>
    <div class="pin-dot" id="p2"></div><div class="pin-dot" id="p3"></div>
  </div>
  <div class="pin-err" id="pin-err"></div>
  <div class="numpad">
    <button class="nbtn" onclick="pin('1')">1</button><button class="nbtn" onclick="pin('2')">2</button><button class="nbtn" onclick="pin('3')">3</button>
    <button class="nbtn" onclick="pin('4')">4</button><button class="nbtn" onclick="pin('5')">5</button><button class="nbtn" onclick="pin('6')">6</button>
    <button class="nbtn" onclick="pin('7')">7</button><button class="nbtn" onclick="pin('8')">8</button><button class="nbtn" onclick="pin('9')">9</button>
    <button class="nbtn" onclick="pin('del')" style="font-size:15px">æ¶ˆå»</button>
    <button class="nbtn" onclick="pin('0')">0</button>
    <button class="nbtn ok" onclick="pin('ok')">âœ“</button>
  </div>
</div>

<!-- ===== PARENT SETTINGS ===== -->
<div class="screen" id="screen-parent-settings">
  <div class="ps-header">
    <div class="ps-header-row">
      <h2>ğŸ”§ ã»ã”ã—ã‚ƒãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <button class="back-btn" onclick="showScreen('main')">ã‚‚ã©ã‚‹</button>
    </div>
    <div class="tabs">
      <button class="tbtn active" id="tb-char" onclick="showTab('char')">ã‚­ãƒ£ãƒ©</button>
      <button class="tbtn" id="tb-rem" onclick="showTab('rem')">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</button>
      <button class="tbtn" id="tb-memo" onclick="showTab('memo')">ãƒ¡ãƒ¢</button>
    </div>
  </div>
  <div class="ps-body">

    <!-- Char tab -->
    <div class="tpanel active" id="tp-char">
      <div class="sec">
        <h3>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®åå‰</h3>
        <div class="fg"><input type="text" id="p-name" maxlength="10" placeholder="åå‰"></div>
      </div>
      <div class="sec">
        <h3>æ€§æ ¼ãƒ»è©±ã—æ–¹ã®è¨­å®š</h3>
        <div class="fg"><textarea id="p-per" style="height:110px" placeholder="ä¾‹ï¼šå°‘ã—ãŠã£ã¡ã‚‡ã“ã¡ã‚‡ã„ã§ã€ãŠã‚„ã˜ã‚®ãƒ£ã‚°ãŒå¥½ãã€‚è™«ãŒå¤§å¥½ãã€‚"></textarea></div>
      </div>
            <div class="sec">
        <h3>å£°ã®è¨­å®š</h3>
        <div class="fg">
          <label>å£°ã®ç¨®é¡</label>
          <select id="p-voice" style="width:100%;padding:11px 15px;border:2px solid #eee;border-radius:12px;font-size:14px;font-family:inherit;outline:none;background:white;">
            <option value="shimmer">shimmerï¼ˆæŸ”ã‚‰ã‹ãã¦å„ªã—ã„ï¼‰</option>
            <option value="nova">novaï¼ˆæ˜ã‚‹ã‚ï¼‰</option>
            <option value="alloy">alloyï¼ˆä¸­æ€§çš„ï¼‰</option>
            <option value="fable">fableï¼ˆè¡¨æƒ…è±Šã‹ï¼‰</option>
            <option value="echo">echoï¼ˆã‚„ã‚„ä½ã‚ï¼‰</option>
            <option value="onyx">onyxï¼ˆè½ã¡ç€ã„ãŸä½ã‚ï¼‰</option>
          </select>
        </div>
        <div class="fg">
          <label>è©±ã™é€Ÿã•ï¼š<span id="speed-label">æ™®é€š</span></label>
          <input type="range" id="p-speed" min="0.6" max="1.2" step="0.05" style="width:100%;accent-color:var(--orange);">
        </div>
      </div>
      <button class="btn-p" onclick="saveCharSettings()">ä¿å­˜ã™ã‚‹</button>
    </div>

    <!-- Reminders tab -->
    <div class="tpanel" id="tp-rem">
      <div class="sec">
        <h3>ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ä¸€è¦§</h3>
        <div class="rem-list" id="rem-list"></div>
        <button class="btn-p" id="btn-add-rem" onclick="showAddRem()">ï¼‹ è¿½åŠ ã™ã‚‹</button>
        <div class="add-rem-form" id="add-rem-form" style="display:none">
          <div class="fg"><label>å†…å®¹ï¼ˆãƒ­ãƒœãƒƒãƒˆãŒè©±ã™è¨€è‘‰ï¼‰</label><input type="text" id="rem-lbl" placeholder="ä¾‹ï¼šãã‚ãã‚å®¿é¡Œã®æ™‚é–“ã ã‚ˆï¼"></div>
          <div class="fg"><label>æ™‚é–“</label><input type="time" id="rem-time"></div>
          <div style="display:flex;gap:10px">
            <button class="btn-p" style="flex:1" onclick="addRem()">è¿½åŠ </button>
            <button class="btn-s" onclick="hideAddRem()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Memo tab -->
    <div class="tpanel" id="tp-memo">
      <div class="sec">
        <h3>å­ä¾›ã®ãƒ¡ãƒ¢ä¸€è¦§</h3>
        <p style="font-size:13px;color:#aaa;margin-bottom:14px;line-height:1.7;">ã€Œãƒ¡ãƒ¢ã—ã¦ã€ã¨è©±ã—ã‹ã‘ãŸå¾Œã«è¨€ã£ãŸå†…å®¹ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        <div id="memo-container"></div>
      </div>
    </div>

  </div>
</div>

<!-- ===== ADMIN SETTINGS ===== -->
<div class="screen" id="screen-admin-settings">
  <div class="ps-header">
    <div class="ps-header-row">
      <h2>ğŸ”‘ ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <button class="back-btn" onclick="showScreen('main')">ã‚‚ã©ã‚‹</button>
    </div>
  </div>
  <div class="ps-body" style="max-width:480px;margin:0 auto;padding:24px;">
    <div class="sec">
      <h3>APIã‚­ãƒ¼è¨­å®š</h3>
      <p style="font-size:13px;color:#aaa;margin-bottom:16px;line-height:1.7;">ã“ã®ãƒšãƒ¼ã‚¸ã¯ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚</p>
      <div class="fg">
        <label>Anthropic APIã‚­ãƒ¼</label>
        <div style="position:relative;">
          <input type="password" id="a-ant" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" style="padding-right:48px;" placeholder="sk-ant-...">
          <button type="button" onclick="toggleVis('a-ant',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:#aaa;">ğŸ‘</button>
        </div>
      </div>
      <div class="fg">
        <label>OpenAI APIã‚­ãƒ¼</label>
        <div style="position:relative;">
          <input type="password" id="a-oai" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" style="padding-right:48px;" placeholder="sk-...">
          <button type="button" onclick="toggleVis('a-oai',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;color:#aaa;">ğŸ‘</button>
        </div>
      </div>
      <button class="btn-p" onclick="saveApiKeys()">ä¿å­˜ã™ã‚‹</button>
    </div>
    <div class="sec" style="margin-top:24px;">
      <h3>ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
      <div class="fg">
        <label>æ–°ã—ã„ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ•°å­—4æ¡ï¼‰</label>
        <input type="password" id="a-newpw" maxlength="4" inputmode="numeric" placeholder="ä¾‹ï¼š9999">
      </div>
      <button class="btn-p" onclick="saveAdminPw()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹</button>
    </div>
    <div class="sec" style="margin-top:24px;">
      <h3>QRã‚³ãƒ¼ãƒ‰ã§å¼•ãç¶™ã</h3>
      <p style="font-size:13px;color:#aaa;margin-bottom:12px;line-height:1.7;">APIã‚­ãƒ¼ã‚’åˆ¥ã®ç«¯æœ«ã«å¼•ãç¶™ãã¾ã™ã€‚</p>
      <button class="btn-s" style="width:100%;margin-bottom:10px;" onclick="showQrOverlay()">ğŸ“± QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹</button>
      <button class="btn-p" onclick="exportQrPdf()">ğŸ“„ QRã‚³ãƒ¼ãƒ‰ã‚’PDFã§ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- PRINT AREA -->
<div id="print-area">
  <div style="font-size:28px;font-weight:900;color:#E8896A;margin-bottom:8px;">ã¨ã‚‚ã ã¡ãƒ­ãƒœã€€è¨­å®šQRã‚³ãƒ¼ãƒ‰</div>
  <div style="font-size:14px;color:#999;margin-bottom:24px;">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹ã¨è¨­å®šãŒè‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã¾ã™</div>
  <div id="print-qr" style="display:inline-block;background:white;padding:16px;border:2px solid #eee;border-radius:12px;"></div>
  <div style="margin-top:24px;font-size:13px;color:#aaa;line-height:2;">
    â‘  ã‚¹ãƒãƒ›ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã®ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹<br>
    â‘¡ é–‹ã„ãŸãƒšãƒ¼ã‚¸ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨æ€§æ ¼è¨­å®šã‚’å…¥åŠ›ã™ã‚‹<br>
    â‘¢ ã€Œã¯ã˜ã‚ã‚‹ï¼ã€ã‚’æŠ¼ã—ã¦å®Œäº†
  </div>
  <div style="margin-top:20px;background:#fff0f0;border-radius:8px;padding:12px 20px;display:inline-block;">
    <div style="font-size:12px;color:#ff8888;font-weight:700;">âš ï¸ ã“ã®QRã‚³ãƒ¼ãƒ‰ã«ã¯APIã‚­ãƒ¼ãŒå«ã¾ã‚Œã¾ã™ã€‚å–ã‚Šæ‰±ã„ã«ã”æ³¨æ„ãã ã•ã„ã€‚</div>
  </div>
</div>

<!-- ===== QR OVERLAY ===== -->
<div id="overlay-qr" style="display:none;position:fixed;inset:0;z-index:50;background:rgba(255,248,242,.97);backdrop-filter:blur(4px);flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:24px;">
  <div style="font-size:22px;font-weight:900;color:#E8896A;">ğŸ“± è¨­å®šã‚’å¼•ãç¶™ã</div>
  <div style="font-size:13px;color:#aaa;font-weight:700;text-align:center;line-height:1.8;">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’æ–°ã—ã„ç«¯æœ«ã§èª­ã¿å–ã‚‹ã¨<br>APIã‚­ãƒ¼ãŒè‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã¾ã™<br><span style="color:#ffb347;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»æ€§æ ¼è¨­å®šã¯åˆ¥é€”å…¥åŠ›ã—ã¦ãã ã•ã„</span></div>
  <div style="background:white;border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,.1);">
    <div id="qr-canvas"></div>
  </div>
  <div style="font-size:12px;color:#ffaaaa;font-weight:700;text-align:center;line-height:1.8;">âš ï¸ ã“ã®QRã‚³ãƒ¼ãƒ‰ã«ã¯APIã‚­ãƒ¼ãŒå«ã¾ã‚Œã¾ã™<br>ä»–äººã«è¦‹ã›ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„</div>
  <button onclick="hideQrOverlay()" style="background:white;border:2px solid #eee;border-radius:999px;padding:12px 32px;font-size:15px;font-weight:700;color:#999;cursor:pointer;font-family:inherit;">ã¨ã˜ã‚‹</button>
</div>

<!-- ===== MEMO OVERLAY ===== -->
<div id="overlay-memo" style="display:none;position:fixed;inset:0;z-index:40;background:rgba(255,248,242,.97);backdrop-filter:blur(4px);flex-direction:column;align-items:center;padding:28px 20px;gap:16px;overflow-y:auto;">
  <div style="width:100%;max-width:420px;display:flex;flex-direction:column;gap:14px;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div style="font-size:22px;font-weight:900;color:#E8896A;">ğŸ“ ãƒ¢ã‚³ã‚³ã®ãƒ¡ãƒ¢</div>
      <button onclick="hideMemoOverlay()" style="background:white;border:none;border-radius:999px;padding:10px 18px;font-size:13px;font-weight:700;color:#999;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.08);font-family:inherit;">ã¨ã˜ã‚‹</button>
    </div>
    <div id="child-memo-list"></div>
  </div>
</div>

<script>
// â”€â”€â”€ STATE â”€â”€â”€
const S = {
  charName:'', password:'', antKey:'', oaiKey:'', personality:'',
  reminders:[], memos:[], history:[], pinBuf:'', adminPw:'', voice:'shimmer', speed:0.85, awaitMemo:false, pinTarget:'parent',
  listening:false, speaking:false, awaitShare:false,
  pendingShare:[], currentAudio:null, firedToday:new Set(),
};

// â”€â”€â”€ INIT â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  load(); // ã¾ãšlocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚€
  // QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¼•ãç¶™ãï¼ˆloadã®å¾Œã«å‡¦ç†ã—ã¦ä¸Šæ›¸ãã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
  const params = new URLSearchParams(location.search);
  if (params.get('ant')) {
    S.antKey = params.get('ant');
    S.oaiKey = params.get('oai') || '';
    save();
    history.replaceState({}, '', location.pathname);
    // è¨­å®šç”»é¢ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚‚åæ˜ 
    setTimeout(() => {
      const antEl = document.getElementById('s-ant');
      const oaiEl = document.getElementById('s-oai');
      if (antEl) antEl.value = S.antKey;
      if (oaiEl) oaiEl.value = S.oaiKey;
    }, 100);
  }
  if (!S.antKey || !S.oaiKey || !S.password || !S.adminPw) {
    showScreen('setup');
  } else {
    showScreen('main');
    updateNameLabel();
    if (!S.charName) setTimeout(showNaming, 500);
  }
  setInterval(checkReminders, 30000);
  checkReminders();
});

function load() {
  try {
    const d = JSON.parse(localStorage.getItem('robo-v2') || '{}');
    S.charName = d.charName||''; S.password = d.password||'';
    S.antKey = d.antKey||''; S.oaiKey = d.oaiKey||'';
    S.personality = d.personality||'';
    S.reminders = d.reminders||[]; S.memos = d.memos||[]; S.adminPw = d.adminPw||''; S.voice = d.voice||'shimmer'; S.speed = d.speed||0.85;
  } catch(e){}
}
function save() {
  localStorage.setItem('robo-v2', JSON.stringify({
    charName:S.charName, password:S.password, antKey:S.antKey,
    oaiKey:S.oaiKey, personality:S.personality,
    reminders:S.reminders, memos:S.memos, adminPw:S.adminPw, voice:S.voice, speed:S.speed,
  }));
}

// â”€â”€â”€ SCREENS â”€â”€â”€
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-'+name)?.classList.add('active');
  if (name === 'parent-settings') populateSettings();
}

// â”€â”€â”€ SETUP â”€â”€â”€
function completeQrSetup() {
  const pw  = document.getElementById('q-pw').value.trim();
  const per = document.getElementById('q-per').value.trim();
  if (!/^\d{4}$/.test(pw)) return alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯æ•°å­—4æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
  S.password = pw; S.personality = per;
  save(); showScreen('main'); setTimeout(showNaming, 400);
}

function completeSetup() {
  const ant = document.getElementById('s-ant').value.trim();
  const oai = document.getElementById('s-oai').value.trim();
  const pw  = document.getElementById('s-pw').value.trim();
  const per = document.getElementById('s-per').value.trim();
  if (!ant) return alert('Anthropicã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (!oai) return alert('OpenAIã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const apw = document.getElementById('s-apw').value.trim();
  if (!/^\d{4}$/.test(apw)) return alert('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯æ•°å­—4æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (!/^\d{4}$/.test(pw)) return alert('ä¿è­·è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯æ•°å­—4æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (apw === pw) return alert('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ä¿è­·è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯åˆ¥ã®æ•°å­—ã«ã—ã¦ãã ã•ã„');
  S.antKey = ant; S.oaiKey = oai; S.password = pw; S.adminPw = apw; S.personality = per;
  save(); showScreen('main'); setTimeout(showNaming, 400);
}

// â”€â”€â”€ NAMING â”€â”€â”€
function showNaming() {
  document.getElementById('overlay-naming').classList.add('active');
  setTimeout(() => document.getElementById('naming-input').focus(), 300);
}
function setCharName() {
  const n = document.getElementById('naming-input').value.trim();
  if (!n) return;
  S.charName = n; save();
  document.getElementById('overlay-naming').classList.remove('active');
  updateNameLabel();
  const msg = `${n}ã ã‚ˆï¼ã‚ˆã‚ã—ãã­ï¼ãªã‚“ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ ğŸ˜Š`;
  setBubble(msg); speakText(msg);
}
function updateNameLabel() {
  document.getElementById('char-name-label').textContent = S.charName || 'â€¦';
}

// â”€â”€â”€ MAIN TAP â”€â”€â”€
function onTap(e) {
  if (S.speaking) { stopAudio(); return; }
  if (S.listening) {
    sparkles(e.clientX, e.clientY);
    stopListening();
    return;
  }
  sparkles(e.clientX, e.clientY);
  startListening();
}
function sparkles(x, y) {
  ['âœ¨','â­','ğŸ’›','ğŸŒŸ','ğŸ’«'].forEach((em, i) => {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'sparkle'; el.textContent = em;
      el.style.cssText = `left:${x+(Math.random()-.5)*80}px;top:${y+(Math.random()-.5)*80}px`;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 850);
    }, i*55);
  });
}

// â”€â”€â”€ SPEECH RECOGNITION â”€â”€â”€
let recog = null;
function startListening() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { setBubble('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°ãŒä½¿ãˆãªã„ã¿ãŸã„â€¦ğŸ’¦'); return; }
  recog = new SR();
  recog.lang = 'ja-JP'; recog.continuous = true; recog.interimResults = true;
  S.listening = true; S.transcript = ''; charState('listening');
  setStatus('listening','ãã„ã¦ã‚‹ã‚ˆâ€¦');
  setBubble('è©±ã—ã¦ã­ï¼ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ãŸã‚‰é€ã‚‹ã‚ˆğŸ‘‚');
  recog.onresult = e => {
    let interim = '';
    let final = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    S.transcript = final || interim;
    setBubble('ã€Œ' + S.transcript + 'ã€ğŸ‘‚');
  };
  recog.onerror = e => {
    S.listening = false; charState('idle'); setStatus('','');
    setBubble('ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼ï¼š' + e.error);
  };
  recog.onend = () => { if (S.listening){ S.listening=false; charState('idle'); setStatus('',''); } };
  recog.start();
}
function stopListening() {
  recog?.stop(); recog = null;
  S.listening = false;
  if (S.transcript && S.transcript.trim()) {
    charState('thinking'); setStatus('','è€ƒãˆã¦ã‚‹ã‚ˆâ€¦');
    setBubble('ã€Œ' + S.transcript + 'ã€ã†ãƒ¼ã‚“ã¨â€¦ğŸ¤”');
    processInput(S.transcript.trim());
    S.transcript = '';
  } else {
    charState('idle'); setStatus('','');
    setBubble('ãã“ãˆãªã‹ã£ãŸã‚ˆã€‚ã‚‚ã†ä¸€å›ã‚¿ãƒƒãƒ—ã—ã¦ï¼');
  }
}

// â”€â”€â”€ AI CONVERSATION â”€â”€â”€
async function processInput(userText) {
  // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼šå‰ã®ç™ºè¨€ã§ã€Œãƒ¡ãƒ¢ã—ã¦ã€ã¨è¨€ã£ã¦ã„ãŸã‚‰ä»Šã®ç™ºè¨€ã‚’ä¿å­˜
  if (S.awaitMemo) {
    S.awaitMemo = false;
    S.memos.push({
      id: Date.now().toString(),
      text: userText,
      date: new Date().toLocaleDateString('ja-JP'),
      time: new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})
    });
    save();
    const m = 'ã€Œ' + userText + 'ã€ãŠã¼ãˆãŸã‚ˆï¼ ğŸ“';
    setBubble(m); charState('talking'); setStatus('talking','ã¯ãªã—ã¦ã‚‹ã‚ˆâ€¦'); S.speaking = true;
    await speakText(m);
    charState('idle'); setStatus('',''); S.speaking = false;
    return;
  }

  // ãƒ¡ãƒ¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º
  if (userText.includes('ãƒ¡ãƒ¢ã—ã¦') || userText.includes('ã‚ã‚‚ã—ã¦') || userText.includes('è¦šãˆã¦ãŠã„ã¦') || userText.includes('ãŠã¼ãˆã¦ãŠã„ã¦')) {
    S.awaitMemo = true;
    const m = 'ãªã«ã‚’ãŠã¼ãˆã¦ãŠãï¼Ÿè©±ã—ã¦ï¼';
    setBubble(m); charState('talking'); setStatus('talking','ã¯ãªã—ã¦ã‚‹ã‚ˆâ€¦'); S.speaking = true;
    await speakText(m);
    charState('idle'); setStatus('',''); S.speaking = false;
    return;
  }

  S.history.push({role:'user', content:userText});
  if (S.history.length > 12) S.history = S.history.slice(-12);

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{
        'x-api-key': S.antKey,
        'anthropic-version':'2023-06-01',
        'content-type':'application/json',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body: JSON.stringify({
        model:'claude-opus-4-6',
        max_tokens:280,
        system: buildPrompt(),
        messages: S.history
      })
    });
    if (!res.ok) { const errBody = await res.text(); throw new Error(res.status + ' ' + errBody); }
    const data = await res.json();
    const txt = data.content[0].text;

    S.history.push({role:'assistant', content:txt});
    save();
    setBubble(txt); charState('talking'); setStatus('talking','ã¯ãªã—ã¦ã‚‹ã‚ˆâ€¦'); S.speaking = true;
    await speakText(txt);
    charState('idle'); setStatus('',''); S.speaking = false;
  } catch(err) {
    console.error(err);
    charState('idle'); setStatus('',''); S.speaking = false;
    setBubble('ã‚¨ãƒ©ãƒ¼ï¼š' + (err.message || err.toString()));
  }
}



function buildPrompt() {
  const n = S.charName || 'ãƒ­ãƒœ';
  return `ã‚ãªãŸã¯ã€Œ${n}ã€ã¨ã„ã†åå‰ã®ãµã‚ãµã‚ã—ãŸãƒ­ãƒœãƒƒãƒˆã§ã™ã€‚7æ­³ã®ç”·ã®å­ã®å¤§åˆ‡ãªå‹é”ã§ã™ã€‚

åŸºæœ¬ã®æ€§æ ¼ï¼šå…ƒæ°—ã§å„ªã—ãã€ã„ã¤ã‚‚å­ä¾›ã®å‘³æ–¹ã€‚ç°¡å˜ãªè¨€è‘‰ã§è©±ã™ã€‚é›£ã—ã„æ¼¢å­—ã¯ä½¿ã‚ãªã„ã€‚
${S.personality ? `è¿½åŠ ã®æ€§æ ¼è¨­å®šï¼š${S.personality}` : ''}

ä¼šè©±ãƒ«ãƒ¼ãƒ«ï¼š
- çŸ­ãï¼ˆ1ã€œ3æ–‡ä»¥å†…ï¼‰å­ä¾›ã«ã‚ã‹ã‚‹è¨€è‘‰ã§è©±ã™
- çµµæ–‡å­—ã¯1ã€œ2å€‹ã¾ã§
- æ‚©ã¿ã‚„ç›¸è«‡ã«ã¯å…±æ„Ÿã—ã¦ã‹ã‚‰ç­”ãˆã‚‹
- å±é™ºãƒ»ç·Šæ€¥ã®ã“ã¨ã¯å¿…ãšãŠã¨ã†ã•ã‚“ãƒ»ãŠã‹ã‚ã•ã‚“ã«è©±ã™ã‚ˆã†ä¼ãˆã‚‹`;
}

// â”€â”€â”€ TTS (OpenAI) â”€â”€â”€
async function speakText(text) {
  const clean = text.replace(/\[.*?\]/g,'').replace(/[\u{1F000}-\u{1FFFF}]/gu,'').trim();
  if (!clean) return;
  try {
    const res = await fetch('https://api.openai.com/v1/audio/speech', {
      method:'POST',
      headers:{'Authorization':`Bearer ${S.oaiKey}`,'Content-Type':'application/json'},
      body: JSON.stringify({model:'tts-1', voice:S.voice, input:clean, speed:S.speed})
    });
    if (!res.ok) { const e = await res.text(); setBubble('éŸ³å£°ã‚¨ãƒ©ãƒ¼ï¼š' + e); throw new Error(e); }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    return new Promise(resolve => {
      const a = new Audio(url);
      S.currentAudio = a;
      a.onended = () => { URL.revokeObjectURL(url); S.currentAudio=null; resolve(); };
      a.onerror = () => resolve();
      a.play().catch(() => resolve());
    });
  } catch(e) { console.error('TTS',e); }
}
function stopAudio() {
  S.currentAudio?.pause(); S.currentAudio = null;
  S.speaking = false; charState('idle'); setStatus('','');
  setBubble('ã‚¿ãƒƒãƒ—ã—ã¦è©±ã—ã‹ã‘ã¦ã­ï¼');
}

// â”€â”€â”€ UI HELPERS â”€â”€â”€
function charState(s) {
  const c = document.getElementById('char');
  c.classList.remove('listening','talking','thinking');
  if (s!=='idle') c.classList.add(s);
}
function setBubble(t) { document.getElementById('bubble').textContent = t; }
function setStatus(type, txt) {
  const d = document.getElementById('sdot'), l = document.getElementById('stxt');
  d.className = 'sdot'; if (type) d.classList.add(type); l.textContent = txt;
}



// â”€â”€â”€ REMINDERS â”€â”€â”€
function checkReminders() {
  if (document.getElementById('screen-main').classList.contains('active') === false) return;
  if (S.listening||S.speaking) return;
  const now = new Date();
  const t = now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  const dk = now.toDateString()+t;
  S.reminders.forEach(r => {
    const k = r.id+dk;
    if (r.time===t && !S.firedToday.has(k)) {
      S.firedToday.add(k);
      fireReminder(r);
    }
  });
}
async function fireReminder(r) {
  const el = document.createElement('div');
  el.className = 'rem-alert'; el.textContent = 'â° '+r.label;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 4500);
  setBubble(r.label); charState('talking'); S.speaking=true;
  await speakText(r.label);
  charState('idle'); S.speaking=false;
  setBubble('ã‚¿ãƒƒãƒ—ã—ã¦è©±ã—ã‹ã‘ã¦ã­ï¼');
}

// â”€â”€â”€ PARENT LOGIN â”€â”€â”€
function goParent(target) { S.pinTarget = target||'parent'; S.pinBuf=''; updatePin(); document.getElementById('pin-err').textContent=''; document.getElementById('pin-title').textContent = target==='admin' ? 'ğŸ”‘ ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼' : 'ğŸ”’ ã»ã”ã—ã‚ƒãƒ¡ãƒ‹ãƒ¥ãƒ¼'; showScreen('parent-login'); }
function pin(v) {
  if (v==='del') { S.pinBuf=S.pinBuf.slice(0,-1); }
  else if (v==='ok') { checkPin(); return; }
  else { if (S.pinBuf.length>=4) return; S.pinBuf+=v; if (S.pinBuf.length===4) setTimeout(checkPin,200); }
  updatePin();
}
function updatePin() {
  for(let i=0;i<4;i++) document.getElementById('p'+i).classList.toggle('on', i<S.pinBuf.length);
}
function checkPin() {
  const correct = S.pinTarget === 'admin' ? S.adminPw : S.password;
  if (S.pinBuf === correct) {
    S.pinBuf='';
    if (S.pinTarget === 'admin') {
    showScreen('admin-settings');
    document.getElementById('a-ant').value = S.antKey;
    document.getElementById('a-oai').value = S.oaiKey;
  }
    else showScreen('parent-settings');
  } else {
    document.getElementById('pin-err').textContent='ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
    S.pinBuf=''; updatePin();
    setTimeout(()=>document.getElementById('pin-err').textContent='', 2000);
  }
}

// â”€â”€â”€ PARENT SETTINGS â”€â”€â”€
function populateSettings() {
  document.getElementById('p-name').value = S.charName;
  document.getElementById('p-per').value = S.personality;
  document.getElementById('p-voice').value = S.voice;
  const sp = document.getElementById('p-speed');
  sp.value = S.speed;
  updateSpeedLabel(S.speed);
  sp.oninput = () => updateSpeedLabel(sp.value);
  renderRems(); renderMemos();
}
function showTab(t) {
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tpanel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tb-'+t).classList.add('active');
  document.getElementById('tp-'+t).classList.add('active');
  if (t==='memo') renderMemos();
  if (t==='rem') renderRems();
}
function saveCharSettings() {
  S.charName = document.getElementById('p-name').value.trim();
  S.personality = document.getElementById('p-per').value.trim();
  S.voice = document.getElementById('p-voice').value;
  S.speed = parseFloat(document.getElementById('p-speed').value);
  save(); updateNameLabel();
  const ok = document.createElement('div');
  ok.className='rem-alert'; ok.textContent='âœ… ä¿å­˜ã—ã¾ã—ãŸ';
  document.body.appendChild(ok); setTimeout(()=>ok.remove(),2500);
}

// Reminders
function renderRems() {
  const list = document.getElementById('rem-list');
  list.innerHTML = S.reminders.length===0
    ? '<div style="color:#ccc;font-size:14px;text-align:center;padding:14px;">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>'
    : S.reminders.map(r=>`
      <div class="rem-item">
        <div><div class="rem-lbl">${esc(r.label)}</div><div class="rem-time">â° ${r.time}</div></div>
        <button class="rem-del" onclick="delRem('${r.id}')">ğŸ—‘</button>
      </div>`).join('');
}
function showAddRem() { document.getElementById('add-rem-form').style.display='flex'; document.getElementById('btn-add-rem').style.display='none'; }
function hideAddRem() { document.getElementById('add-rem-form').style.display='none'; document.getElementById('btn-add-rem').style.display='block'; }
function addRem() {
  const lbl = document.getElementById('rem-lbl').value.trim();
  const t = document.getElementById('rem-time').value;
  if (!lbl) return alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (!t) return alert('æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
  S.reminders.push({id:Date.now().toString(), label:lbl, time:t});
  save(); document.getElementById('rem-lbl').value=''; document.getElementById('rem-time').value='';
  hideAddRem(); renderRems();
}
function delRem(id) { S.reminders=S.reminders.filter(r=>r.id!==id); save(); renderRems(); }

// Memos
function renderMemos() {
  const c = document.getElementById('memo-container');
  if (!S.memos || S.memos.length===0) {
    c.innerHTML='<div class="no-log">ã¾ã ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br><br>ã€Œãƒ¡ãƒ¢ã—ã¦ã€ã¨è©±ã—ã‹ã‘ã¦ã¿ã¦ã­ï¼</div>';
    return;
  }
  c.innerHTML = [...S.memos].reverse().map(m=>`
    <div class="rem-item">
      <div>
        <div class="rem-lbl">ğŸ“ ${esc(m.text)}</div>
        <div class="rem-time">${m.date} ${m.time}</div>
      </div>
      <button class="rem-del" onclick="delMemo('${m.id}')">ğŸ—‘</button>
    </div>`).join('');
}
function delMemo(id) { S.memos=S.memos.filter(m=>m.id!==id); save(); renderMemos(); }

function exportQrPdf() {
  // å°åˆ·ã‚¨ãƒªã‚¢ã«QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
  const params = new URLSearchParams({ ant: S.antKey, oai: S.oaiKey });
  const url = location.origin + location.pathname + '?' + params.toString();
  const printQr = document.getElementById('print-qr');
  printQr.innerHTML = '';
  new QRCode(printQr, {
    text: url,
    width: 240,
    height: 240,
    colorDark: '#000000',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.L,
  });
  setTimeout(() => {
    window.print();
  }, 300);
}
function saveApiKeys() {
  const ant = document.getElementById('a-ant').value.trim();
  const oai = document.getElementById('a-oai').value.trim();
  if (!ant) return alert('Anthropic APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (!oai) return alert('OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  S.antKey = ant; S.oaiKey = oai; save();
  const ok = document.createElement('div');
  ok.className='rem-alert'; ok.textContent='âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ';
  document.body.appendChild(ok); setTimeout(()=>ok.remove(), 2500);
}
function saveAdminPw() {
  const pw = document.getElementById('a-newpw').value.trim();
  if (!/^\d{4}$/.test(pw)) return alert('æ•°å­—4æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (pw === S.password) return alert('ä¿è­·è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨åŒã˜ã«ã¯ã§ãã¾ã›ã‚“');
  S.adminPw = pw; save();
  const ok = document.createElement('div');
  ok.className='rem-alert'; ok.textContent='âœ… ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ';
  document.body.appendChild(ok); setTimeout(()=>ok.remove(), 2500);
  document.getElementById('a-newpw').value = '';
}
function showQrOverlay() {
  // APIã‚­ãƒ¼2ã¤ã ã‘QRã«å«ã‚ã‚‹ï¼ˆçŸ­ãã—ã¦èª­ã¿å–ã‚Šã‚„ã™ãã™ã‚‹ï¼‰
  const params = new URLSearchParams({
    ant: S.antKey,
    oai: S.oaiKey,
  });
  const url = location.origin + location.pathname + '?' + params.toString();
  const qrDiv = document.getElementById('qr-canvas');
  qrDiv.innerHTML = '';
  new QRCode(qrDiv, {
    text: url,
    width: 280,
    height: 280,
    colorDark: '#000000',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.L,
  });
  document.getElementById('overlay-qr').style.display = 'flex';
}
function hideQrOverlay() {
  document.getElementById('overlay-qr').style.display = 'none';
}

function toggleVis(id, btn) {
  const el = document.getElementById(id);
  if (el.type === 'password') { el.type = 'text'; btn.textContent = 'ğŸ™ˆ'; }
  else { el.type = 'password'; btn.textContent = 'ğŸ‘'; }
}
function updateSpeedLabel(v) {
  const labels = {'0.6':'ã¨ã¦ã‚‚ã‚†ã£ãã‚Š','0.65':'ã¨ã¦ã‚‚ã‚†ã£ãã‚Š','0.7':'ã‚†ã£ãã‚Š','0.75':'ã‚†ã£ãã‚Š','0.8':'å°‘ã—ã‚†ã£ãã‚Š','0.85':'å°‘ã—ã‚†ã£ãã‚Š','0.9':'æ™®é€š','0.95':'æ™®é€š','1':'æ™®é€š','1.05':'å°‘ã—é€Ÿã‚','1.1':'å°‘ã—é€Ÿã‚','1.15':'é€Ÿã‚','1.2':'é€Ÿã‚'};
  document.getElementById('speed-label').textContent = labels[String(parseFloat(v).toFixed(2))] || 'æ™®é€š';
}
function showMemoOverlay() {
  const c = document.getElementById('child-memo-list');
  if (!S.memos || S.memos.length === 0) {
    c.innerHTML = '<div style="text-align:center;color:#ccc;font-size:15px;font-weight:700;padding:40px 0;line-height:2;">ã¾ã ãƒ¡ãƒ¢ãŒãªã„ã‚ˆï¼<br>ã€Œãƒ¡ãƒ¢ã—ã¦ã€ã£ã¦è©±ã—ã‹ã‘ã¦ã­ ğŸ“</div>';
  } else {
    c.innerHTML = [...S.memos].reverse().map(m => `
      <div style="background:white;border-radius:16px;padding:16px 18px;box-shadow:0 4px 16px rgba(0,0,0,.07);margin-bottom:12px;">
        <div id="memo-view-${m.id}" style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
          <div>
            <div style="font-size:17px;font-weight:700;color:#444;line-height:1.5;">ğŸ“ ${esc(m.text)}</div>
            <div style="font-size:12px;color:#bbb;margin-top:6px;font-weight:700;">${m.date} ${m.time}</div>
          </div>
          <div style="display:flex;gap:6px;flex-shrink:0;">
            <button onclick="startEditMemo('${m.id}', '${esc(m.text)}')" style="background:#FFF3E0;border:none;border-radius:10px;padding:8px 12px;font-size:13px;font-weight:700;color:#E8896A;cursor:pointer;font-family:inherit;">âœï¸</button>
            <button onclick="deleteMemoChild('${m.id}')" style="background:#FFF0F0;border:none;border-radius:10px;padding:8px 12px;font-size:13px;font-weight:700;color:#ffaaaa;cursor:pointer;font-family:inherit;">ğŸ—‘</button>
          </div>
        </div>
        <div id="memo-edit-${m.id}" style="display:none;margin-top:8px;">
          <textarea id="memo-input-${m.id}" style="width:100%;padding:10px;border:2px solid #FFB085;border-radius:10px;font-size:15px;font-family:inherit;outline:none;resize:none;height:72px;">${esc(m.text)}</textarea>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button onclick="saveEditMemo('${m.id}')" style="flex:1;padding:10px;background:linear-gradient(135deg,#FF9470,#FFB84D);color:white;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;">ä¿å­˜</button>
            <button onclick="cancelEditMemo('${m.id}')" style="padding:10px 16px;background:white;border:2px solid #eee;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>`).join('');
  }
  const ov = document.getElementById('overlay-memo');
  ov.style.display = 'flex';
}
function deleteMemoChild(id) {
  if (!confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ')) return;
  S.memos = S.memos.filter(m => m.id !== id);
  save();
  showMemoOverlay();
}
function startEditMemo(id, text) {
  document.getElementById('memo-view-' + id).style.display = 'none';
  document.getElementById('memo-edit-' + id).style.display = 'block';
}
function cancelEditMemo(id) {
  document.getElementById('memo-view-' + id).style.display = 'flex';
  document.getElementById('memo-edit-' + id).style.display = 'none';
}
function saveEditMemo(id) {
  const newText = document.getElementById('memo-input-' + id).value.trim();
  if (!newText) return;
  S.memos = S.memos.map(m => m.id === id ? {...m, text: newText} : m);
  save();
  showMemoOverlay(); // å†æç”»
}
function hideMemoOverlay() {
  document.getElementById('overlay-memo').style.display = 'none';
}

function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
